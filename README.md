# Notes Assistant (multi-DB demo)
===============================

## Идея проекта
“Персональный помощник заметок”: веб-API, где пользователь создаёт заметки; быстрый поиск по тексту, поиск похожих заметок (векторный), граф связей между заметками/темами.

### Что используется:
- PostgreSQL — хранение пользователей, заметок, тегов, статистики.
- Redis — кэш популярных заметок и очереди rate limit/session store.
- MongoDB — хранение версий заметок и вложений (JSON + бинарь).
- Qdrant — векторный поиск похожих заметок (эмбеддинги текста).
- Neo4j — граф связей “заметка ↔ тема/тег”, “заметка ↔ заметка” (желательно).
- RabbitMQ — фоновые задачи: генерация эмбеддингов и построение графовых связей после создания/обновления заметки.

## Базовая архитектура (простая микросервисная)
- api (FastAPI/Express): принимает запросы, пишет в Postgres, кладёт задания в RabbitMQ, читает из Redis кэш.
- worker (Python/Node): потребляет очереди из RabbitMQ, генерирует эмбеддинги, пишет в Qdrant, обновляет Neo4j, сохраняет версию в MongoDB.
- db: docker-compose для всех сервисов (Postgres, Redis, MongoDB, Qdrant, Neo4j, RabbitMQ). Можно держать всё в одном репо с двумя сервисами (api и worker) и compose в корне.

### Минимальный функционал
- Создать/обновить/получить заметку (REST).
- Быстрый поиск по тексту (Postgres GIN по tsvector).
- Поиск похожих заметок (Qdrant, косинусная близость).
- Граф связей по тегам (Neo4j: вершины Note, Tag).
- Версионирование заметок и вложений (MongoDB: коллекции note_versions, attachments).
- Кэш: топ-N популярных заметок (Redis, TTL).
- Очереди: при создании/обновлении заметки отправить в RabbitMQ задачу `build_embeddings_and_graph`.

## Потоки
- API сохраняет заметку в Postgres, версию в MongoDB, пушит задачу в RabbitMQ.
- Worker берёт задачу, генерит эмбеддинг (stub/fake), пишет в Qdrant, обновляет Neo4j связи, обновляет кэш Redis.

**Тестовый сценарий:** создать пару заметок с общими тегами, вызвать поиск и похожие, посмотреть граф.

## Структура, запуск, эндпойнты (черновик)
- Структура: корень с `docker-compose.yml`, папки `api/` и `worker/`, docs/, env-файлы.
- Запуск: `cp .env.example .env`, заполнить хост/порты, поднять нужные сервисы (удалённые или по compose), запустить api и worker.
- Эндпойнты (набросок): `POST /notes`, `GET /notes/{id}`, `GET /notes/search?q=...`, `GET /notes/similar/{id}`, `GET /graph/tags/{tag}`.
- Основные функции: CRUD заметок в Postgres, версии в MongoDB, кэш Redis, векторный поиск Qdrant, граф связей Neo4j, очереди RabbitMQ для фоновых задач.

## Что уже есть
- Подключение к удалённым базам через `.env`.
- Скрипт `scripts/check_connections.py` для проверки всех сервисов.
- Минимальный API (FastAPI) с CRUD по заметкам в Postgres:
  - `POST /notes` — создать заметку `{title, content, tags?}`
  - `GET /notes/{id}` — получить по id
  - `GET /notes?q=...&limit=20&offset=0` — список/поиск (ILIKE по title/content)
  - `PUT /notes/{id}` — обновить title/content/tags
  - `GET /notes/{id}/versions` — версии заметки из MongoDB
- Таблица создаётся автоматически на старте: `notes_<student>` если указан `STUDENT_NAME`, иначе `notes`.

## Как запустить API локально
1. Установить зависимости: `pip install -r requirements.txt`
2. Запустить: `uvicorn api.main:app --reload --port 8000`
3. Проверить: `GET /health`, `GET /ping`, затем CRUD-эндпойнты выше.
